# Copyright (c) Markus Falb <markus.falb@mafalb.at>
# GNU General Public License v3.0+
# see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt
---
- name: RPM gpg key is present
  ansible.builtin.copy:
    src: RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}
    dest: /etc/pki/rpm-gpg/
    mode: '0644'

- name: RPM gpg key is imported
  ansible.builtin.rpm_key:
    key: /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}

- name: Package epel-release is present
  ansible.builtin.package:
    name: "{{ (epel_packages + epel_next_package) if epel_next else epel_packages }}"

- name: Enable dependency repos
  block:
    - name: Enable dependency repos (RHEL)
      community.general.rhsm_repository:
        name: "{{ epel_repos }}"
      when: ansible_distribution == 'RedHat'

    - name: Enable dependency repos (RHEL clones)
      when: ansible_distribution != 'RedHat'
      ansible.builtin.command:
        cmd: dnf config-manager --set-enabled {{ repo }}
      loop_control:
        loop_var: repo
      loop: "{{ epel_repos }}"
...
